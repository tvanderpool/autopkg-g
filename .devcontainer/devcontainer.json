// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/rust
{
	"name": "Rust",
    "image": "mcr.microsoft.com/devcontainers/rust:1-trixie",
	
	// "workspaceFolder": "/workspaces",
	// "workspaceMount": "source=${localWorkspaceFolder},target=/workspaces,type=bind",

	// Use 'mounts' to make the cargo cache persistent in a Docker Volume.
	"mounts": [
		{
			"source": "devcontainer-cargo-cache-${devcontainerId}",
			"target": "/usr/local/cargo",
			"type": "volume"
		}/* ,
		{
			"source": "devcontainer-cmdhistory-${devcontainerId}",
			"target": "/cmdhistory",
			"type": "volume"
		} */
		// {
		// 	"source": "/var/run/docker.sock",
		// 	"target": "/var/run/docker.sock",
		// 	"type": "bind"
		// }
	],
	"runArgs": ["--add-host=host.docker.internal:host-gateway"],
	// Features to add to the dev container. More info: https://containers.dev/features.
	"features": {
		"ghcr.io/earthly/devcontainer-features/earthly": {},
		"ghcr.io/stuartleeks/dev-container-features/shell-history": {},
		"ghcr.io/devcontainers/features/docker-in-docker": {
			"moby": false
		},
		"ghcr.io/devcontainers-extra/features/zsh-plugins": {
			"plugins": "history-substring-search vscode rust",
			"ohmyzsh": true,
			"powerlevel10k": true,
			"p10kConfig": "https://gist.githubusercontent.com/tvanderpool/1bb83bc4fcb9e47190f8dd3ad3c001fa/raw/506c9ddf27bbdd8efd41558e710e9f88fa8e3c1a/my-p10k.zsh"
		},
		"ghcr.io/devcontainers-extra/features/apt-packages": {
			"packages": "cmake musl-tools"
			// "packages": "curl, git, lldb, lld, build-essential, libssl-dev, pkg-config, libclang-dev, clang, cmake, gdb, gdbserver, vim, zsh, fzf, htop, unzip, wget"
		}
	},
	"containerEnv": {
		"RUST_BACKTRACE": "1"
	},
	// Use 'forwardPorts' to make a list of ports inside the container available locally.
	// "forwardPorts": [],
	// Use 'postCreateCommand' to run commands after the container is created.
	"postCreateCommand": {
		// "claude": "npm install -g @anthropic-ai/claude-code",
		// "apt": "sudo apt-get update && sudo apt-get install -y cmake",
		"cargo-owner": "sudo chown -R 1000:1000 /usr/local/cargo",
		"rust-target": "rustup target add x86_64-unknown-linux-musl",
		"omz": "${containerWorkspaceFolder}/.devcontainer/shell-setup.sh"
	},
    // "postCreateCommand": "rustc --version",
	// Configure tool-specific properties.
	"customizations": {
		"vscode": {
			"extensions": [
				"tamasfe.even-better-toml",
				"GitHub.copilot",
				"rust-lang.rust-analyzer",
				"vscode-icons-team.vscode-icons",
				"GitHub.copilot-chat",
				"fill-labs.dependi",
				"gurumukhi.selected-lines-count",
				"vadimcn.vscode-lldb",
				"ZhangYue.rust-mod-generator",
				"ms-vscode-remote.remote-containers",
				"dustypomerleau.rust-syntax",
				"mhutchie.git-graph",
				"bibhasdn.unique-lines",
				"earthly.earthfile-syntax-highlighting",
				"ConradLudgate.rust-playground",
				"jinxdash.prettier-rust",
				"JScearcy.rust-doc-viewer"
			],
			"settings": {
				"terminal.integrated.defaultProfile.linux": "zsh"
			}
		}
	},

	// Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
	"remoteUser": "vscode"
}
